#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฑััััะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั ะฑะพัะฐ ะฝะฐ Timeweb Cloud ัะตัะตะท GitHub

echo "๐ ะะฐัะธะฝะฐั ะพะฑะฝะพะฒะปะตะฝะธะต ะฑะพัะฐ ัะตัะตะท GitHub..."

# ะะตัะตัะพะด ะฒ ะฟะฐะฟะบั ะฑะพัะฐ
cd ~/telegram_bot || cd /root/telegram_bot || {
    echo "โ ะะฐะฟะบะฐ ั ะฑะพัะพะผ ะฝะต ะฝะฐะนะดะตะฝะฐ!"
    echo "ะฃะบะฐะถะธัะต ะฟััั ะบ ะฟะฐะฟะบะต ะฑะพัะฐ:"
    read BOT_PATH
    cd "$BOT_PATH" || exit 1
}

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Git ัะตะฟะพะทะธัะพัะธั
if [ ! -d ".git" ]; then
    echo "โ Git ัะตะฟะพะทะธัะพัะธะน ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "ะะฝะธัะธะฐะปะธะทะธััะนัะต ัะตะฟะพะทะธัะพัะธะน ะธะปะธ ะพะฑะฝะพะฒะธัะต ัะฐะนะปั ะฒัััะฝัั."
    exit 1
fi

# ะััะฐะฝะพะฒะบะฐ ัะตะบััะตะณะพ ะฟัะพัะตััะฐ
echo "โน ะััะฐะฝะฐะฒะปะธะฒะฐั ัะตะบััะธะน ะฟัะพัะตัั..."
pkill -f "python main.py" || pkill -f "python3 main.py" || echo "ะัะพัะตัั ะฝะต ะฝะฐะนะดะตะฝ"
sleep 1

# ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท git
echo "๐ฅ ะะฑะฝะพะฒะปัั ะบะพะด ะธะท GitHub..."
if git pull origin main; then
    echo "โ ะะพะด ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝ!"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ะธะท GitHub!"
    echo "ะัะพะฒะตัััะต ะฟะพะดะบะปััะตะฝะธะต ะธ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ."
    exit 1
fi

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะทะฐะฒะธัะธะผะพััะธ..."
if pip install -r requirements.txt || pip3 install -r requirements.txt; then
    echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั!"
else
    echo "โ๏ธ ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะฝะตะบะพัะพััะต ะทะฐะฒะธัะธะผะพััะธ ะฝะต ัััะฐะฝะพะฒะธะปะธัั"
fi

# ะัะพะฒะตัะบะฐ FFmpeg
if ! command -v ffmpeg &> /dev/null; then
    echo "โ๏ธ FFmpeg ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต ะตะณะพ ะดะปั ัะฐะฑะพัั ั ะฐัะดะธะพ:"
    echo "   sudo apt install ffmpeg  # ะดะปั Ubuntu/Debian"
    echo "   sudo yum install ffmpeg   # ะดะปั CentOS/RHEL"
else
    echo "โ FFmpeg ัััะฐะฝะพะฒะปะตะฝ"
fi

# ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝะพะน ะพะบััะถะตะฝะธั BOT_TOKEN
if [ -z "$BOT_TOKEN" ]; then
    echo "โ๏ธ BOT_TOKEN ะฝะต ัััะฐะฝะพะฒะปะตะฝ ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั!"
    echo "   ะฃััะฐะฝะพะฒะธัะต: export BOT_TOKEN='ะฒะฐั-ัะพะบะตะฝ'"
    echo "   ะะปะธ ะดะพะฑะฐะฒััะต ะฒ ~/.bashrc ะดะปั ะฟะพััะพัะฝััะฒะฐ"
fi

# ะะฐะฟััะบ ะฑะพัะฐ
echo "๐ ะะฐะฟััะบะฐั ะฑะพัะฐ..."
nohup python main.py > bot.log 2>&1 &
BOT_PID=$!

# ะัะพะฒะตัะบะฐ ะทะฐะฟััะบะฐ
sleep 3
if ps -p $BOT_PID > /dev/null 2>&1 || pgrep -f "python main.py" > /dev/null; then
    echo "โ ะะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ PID ะฟัะพัะตััะฐ: $(pgrep -f 'python main.py')"
    echo "๐ ะัะพัะผะพัั ะปะพะณะพะฒ: tail -f bot.log"
    echo ""
    echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะทะฐะฟััะบะต. ะัะพะฒะตัััะต ะปะพะณะธ:"
    echo "   tail -100 bot.log"
    exit 1
fi

